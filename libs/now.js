/*! now.js build:0.8.1. Copyright(c) 2011 Flotype <team@flotype.com> MIT Licensed */
var nowObjects={};module.exports={nowInitialize:function noConflict(uri){if(Object.prototype.hasOwnProperty.call(nowObjects,uri))return nowObjects[uri];var io=require("socket.io-client"),Proxy=require("node-proxy"),socket=io.connect(uri),closures={},nowReady=!1,lastTimeout,core={},util,lib,ready=function(func){util.on("ready",func)},wrap=function(entity){function wrapRoot(path,proto){return Proxy.create({get:function(receiver,name){if(entity.arrays[path]!==undefined&&name==="length")return entity.arrays[path];var fqn=path+"."+name;if(fqn==="now.core")return core;if(fqn==="now.ready")return ready;var returnObj=entity.get(fqn);return returnObj&&typeof returnObj=="object"?entity.proxies[fqn]?entity.proxies[fqn]:entity.proxies[fqn]=wrapRoot(fqn,(returnObj.filter&&returnObj.filter(isNaN).length?Object:Array).prototype):returnObj===undefined&&proto[name]?proto[name]:returnObj},set:function(receiver,name,val){var fqn=path+"."+name,len=entity.arrays[path];if(len){if(name==="length"){entity.arrays[path]=val;return val}while(len<name)receiver[len++]=undefined;entity.arrays[path]=name+1}entity.set(fqn,val);if(!val||typeof val!="object")return val;Array.isArray(val)&&entity.flagAsArray(fqn,val.length);return entity.proxies[fqn]=wrapRoot(fqn,val.constructor.prototype)},enumerate:function(){return entity.get(path)},hasOwn:function(name){return entity.get(path+"."+name)!==undefined},"delete":function(name){entity.deleteVar(path+"."+name)},fix:function(){return undefined}},proto)}return wrapRoot("now",Object.prototype)},fqnMap={arrays:{},proxies:{},data:{},get:function(fqn){return this.data[fqn]},set:function(fqn,val){this.data[fqn]!==undefined&&this.deleteVar(fqn,val);var lastIndex=fqn.lastIndexOf("."),parent=fqn.substring(0,lastIndex);this.addParent(parent,fqn.substring(lastIndex+1));if((typeof val!="object"||!val)&&fqn!=="now.ready"){var obj={};obj[fqn]=util.getValOrFqn(val,fqn);fqn!==undefined&&val!==fqnMap.data[fqn]&&socket.emit("rv",obj)}return this.data[fqn]=val},addParent:function(parent,key){parent&&!Array.isArray(this.data[parent])&&this.set(parent,[]);parent&&this.data[parent].push(key)},deleteVar:function(fqn){var lastIndex=fqn.lastIndexOf("."),parent=fqn.substring(0,lastIndex);if(util.hasProperty(this.data,parent)){var index=this.data[parent].indexOf(fqn.substring(lastIndex+1));index>-1&&this.data[parent].splice(index,1)}if(Array.isArray(this.data[fqn]))for(var i=0;this.data[fqn].length;)this.deleteVar(fqn+"."+this.data[fqn][i]);delete this.data[fqn]}};util={hasProperty:function(obj,prop){return Object.prototype.hasOwnProperty.call(Object(obj),prop)},isArray:Array.isArray,createVarAtFqn:function(scope,fqn,value){var path=fqn.split("."),currVar=this.forceGetParentVarAtFqn(scope,fqn),key;fqnMap.data[fqn]=value},forceGetParentVarAtFqn:function(scope,fqn){var path=fqn.split(".");path.shift();var currVar=scope;while(path.length>1){var prop=path.shift();if(!this.hasProperty(currVar,prop)||!currVar[prop]||typeof currVar[prop]!="object")isNaN(path[0])?currVar[prop]={}:currVar[prop]=[];currVar=currVar[prop]}return currVar},getVarFromFqn:function(scope,fqn){var path=fqn.split(".");path.shift();var currVar=scope;while(path.length>0){var prop=path.shift();if(!this.hasProperty(currVar,prop))return!1;currVar=currVar[prop]}return currVar},generateRandomString:function(){return Math.random().toString().substr(2)},getValOrFqn:function(val,fqn){return typeof val=="function"?val.remote?undefined:{fqn:fqn}:val}};util.__proto__=require("events").EventEmitter.prototype;var now=wrap(fqnMap);lib={deleteVar:function(fqn){var path,currVar,parent,key;path=fqn.split(".");currVar=now;for(var i=1;i<path.length;i++){key=path[i];if(currVar===undefined){fqnMap.deleteVar(fqn);return}if(i===path.length-1){delete currVar[path.pop()];fqnMap.deleteVar(fqn);return}currVar=currVar[key]}},replaceVar:function(data){for(var fqn in data){util.hasProperty(data[fqn],"fqn")&&(data[fqn]=lib.constructRemoteFunction(fqn));util.createVarAtFqn(now,fqn,data[fqn])}},remoteCall:function(data){var func,i,ii;data.fqn.split("_")[0]==="closure"?func=closures[data.fqn]:func=fqnMap.get(data.fqn);var args=data.args;if(typeof args=="object"&&!util.isArray(args)){var newargs=[];for(i in args)newargs.push(args[i]);args=newargs}for(i=0,ii=args.length;i<ii;i++)util.hasProperty(args[i],"fqn")&&(args[i]=lib.constructRemoteFunction(args[i].fqn));func.apply({now:now},args)},serverReady:function(){nowReady=!0;util.emit("ready")},constructRemoteFunction:function(fqn){var remoteFn=function(){var args=Array.prototype.slice.call(arguments);for(var i=0,ii=args.length;i<ii;i++)if(typeof args[i]=="function"){var closureId="closure_"+args[i].name+"_"+util.generateRandomString();closures[closureId]=args[i];args[i]={fqn:closureId}}socket.emit("rfc",{fqn:fqn,args:args})};remoteFn.remote=!0;return remoteFn},handleNewConnection:function(socket){if(socket.handled)return;socket.handled=!0;socket.on("rfc",function(data){lib.remoteCall(data);util.emit("rfc",data)});socket.on("rv",function(data){lib.replaceVar(data);util.emit("rv",data)});socket.on("del",function(data){lib.deleteVar(data);util.emit("del",data)});socket.on("rd",function(data){lib.serverReady()});socket.on("disconnect",function(){util.emit("disconnect")});socket.on("error",function(){util.emit("error")});socket.on("retry",function(){util.emit("retry")});socket.on("reconnect",function(){util.emit("reconnect")});socket.on("reconnect_failed",function(){util.emit("reconnect_failed")});socket.on("connect_failed",function(){util.emit("connect_failed")})}};core.socketio=socket;socket.on("connect",function(){core.clientId=socket.id;socket.connected=!0;lib.handleNewConnection(socket);socket.emit("rd");util.emit("connect")});socket.on("disconnect",function(){socket.connected=!1;(function(y){y(y,now)})(function(fn,obj){for(var i in obj)obj[i]&&typeof obj[i]=="object"&&obj[i]!==now.core?fn(fn,obj[i]):typeof obj[i]=="function"&&obj[i].remote&&delete obj[i]});fqnMap.data={}});return nowObjects[uri]=now}};